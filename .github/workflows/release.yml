name: Release

on:
  push:
    tags:
      - "v*.*.*"

env:
  GO_VERSION: "1.25.4"

permissions:
  contents: write

jobs:
  test:
    name: Test Before Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install dependencies
        run: go mod download

      - name: Run tests
        run: go test -race ./...

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: v2.4.0

      - name: Build examples
        run: make examples

  release:
    name: Create Release
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Release
        uses: softprops/action-gh-release@v2
        id: create_release
        with:
          generate_release_notes: true

  update-changelog:
    name: Update Changelog
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Get previous tag
        id: previous_tag
        run: |
          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -v "^${GITHUB_REF#refs/tags/}$" | head -n 1)
          echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
          echo "Previous tag: $PREVIOUS_TAG"

      - name: Generate changelog entry
        id: generate_changelog
        run: |
          VERSION=${{ steps.get_version.outputs.version }}
          PREVIOUS_TAG=${{ steps.previous_tag.outputs.previous_tag }}
          DATE=$(date +%Y-%m-%d)

          # Get commits since previous tag
          if [ -z "$PREVIOUS_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s" --no-merges)
          else
            COMMITS=$(git log ${PREVIOUS_TAG}..${GITHUB_REF#refs/tags/} --pretty=format:"- %s" --no-merges)
          fi

          # Create changelog entry
          cat > /tmp/new_changelog.txt << EOF
          ## [$VERSION] - $DATE

          ### Added

          $(echo "$COMMITS" | grep -i "^- feat\|^- add" | sed 's/^- feat: /- /i; s/^- add: /- /i' || echo "")

          ### Changed

          $(echo "$COMMITS" | grep -i "^- update\|^- change\|^- refactor" | sed 's/^- update: /- /i; s/^- change: /- /i; s/^- refactor: /- /i' || echo "")

          ### Fixed

          $(echo "$COMMITS" | grep -i "^- fix" | sed 's/^- fix: /- /i' || echo "")

          EOF

          # Remove empty sections
          sed -i '/^### /!b; N; /\n$/d' /tmp/new_changelog.txt

      - name: Update CHANGELOG.md
        run: |
          # Insert new entry after [Unreleased] section
          awk '
          /^## \[Unreleased\]/ {
            print
            print ""
            while ((getline line < "/tmp/new_changelog.txt") > 0) {
              print line
            }
            next
          }
          { print }
          ' CHANGELOG.md > /tmp/CHANGELOG.md.new

          mv /tmp/CHANGELOG.md.new CHANGELOG.md

      - name: Commit and push changelog
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "chore: update CHANGELOG for version ${{ steps.get_version.outputs.version }} release"
          git push origin HEAD:main
